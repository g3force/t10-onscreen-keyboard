<?xml version="1.0" encoding="UTF-8"?>
<?eclipse.ant.import?>
<project basedir="." default="compress" name="build-custom">
	<import file="build-properties.xml" />
	<target name="pre-build" description="Prepare some things before building project. Should be called before standard build target!">
		<copy todir="bin">
			<fileset dir="lib" />
		</copy>

		<exec executable="git" output="src/res/version" failifexecutionfails="false">
			<arg line="describe" />
			<arg line="--tags" />
		</exec>
	</target>

	<target depends="init" name="pack-exe">
		<replaceregexp file="launch4j.xml" match="&lt;jar&gt;.*&lt;/jar&gt;" replace="&lt;jar&gt;${build.path}/${file.name}.jar&lt;/jar&gt;" byline="true" />
		<replaceregexp file="launch4j.xml" match="&lt;outfile&gt;.*&lt;/outfile&gt;" replace="&lt;outfile&gt;${build.path}/${file.name}.exe&lt;/outfile&gt;" byline="true" />
		<exec executable="launch4j" failifexecutionfails="true">
			<arg line="${basedir}/launch4j.xml" />
		</exec>
	</target>

	<target depends="init, pack-updater" name="pack-updater-exe">
		<replaceregexp file="launch4j-updater.xml" match="&lt;jar&gt;.*&lt;/jar&gt;" replace="&lt;jar&gt;${build.path}/${updater.file.name}.jar&lt;/jar&gt;" byline="true" />
		<replaceregexp file="launch4j-updater.xml" match="&lt;outfile&gt;.*&lt;/outfile&gt;" replace="&lt;outfile&gt;${build.path}/${updater.file.name}.exe&lt;/outfile&gt;" byline="true" />
		<exec executable="launch4j" failifexecutionfails="true">
			<arg line="${basedir}/launch4j-updater.xml" />
		</exec>
	</target>

	<target depends="init" name="pack-jar" description="Pack everything into a runnable jar">
		<jar destfile="${build.path}/${file.name}.jar" basedir="bin">
			<manifest>
				<attribute name="Built-By" value="${user.name}" />
				<attribute name="Implementation-Vendor" value="UseAcc/FIT42" />
				<attribute name="Implementation-Title" value="T10-OnScreen-Keyboard" />
				<attribute name="Implementation-Version" value="${version}" />
				<attribute name="Main-Class" value="org.eclipse.jdt.internal.jarinjarloader.JarRsrcLoader" />
				<attribute name="Rsrc-Class-Path" value="./ log4j-1.2.16.jar" />
				<attribute name="Class-Path" value="." />
				<attribute name="Rsrc-Main-Class" value="edu.dhbw.t10.SuperFelix" />
			</manifest>
		</jar>
	</target>

	<target name="build-updater" depends="init" description="Build a single instance of the Updater">
		<mkdir dir="updater-bin" />
		<path id="updater.classpath">
			<pathelement location="bin/" />
			<pathelement location="lib/log4j-1.2.16.jar" />
		</path>
		<javac srcdir="src" destdir="updater-bin" source="1.6" target="1.6" includes="edu/dhbw/t10/Updater.java" />
	</target>

	<target depends="build-updater" name="pack-updater" description="Pack Updater into a runnable jar">
		<jar destfile="${build.path}/${updater.file.name}.jar" basedir="updater-bin">
			<manifest>
				<attribute name="Built-By" value="${user.name}" />
				<attribute name="Implementation-Vendor" value="UseAcc/FIT42" />
				<attribute name="Implementation-Title" value="T10-OnScreen-Keyboard Updater" />
				<attribute name="Implementation-Version" value="${version}" />
				<attribute name="Main-Class" value="org.eclipse.jdt.internal.jarinjarloader.JarRsrcLoader" />
				<attribute name="Class-Path" value="." />
				<attribute name="Rsrc-Main-Class" value="edu.dhbw.t10.Updater" />
			</manifest>
		</jar>
	</target>

	<target name="clean-build">
		<delete>
			<fileset dir="build" includes="*.jar" />
			<fileset dir="build" includes="*.exe" />
		</delete>
	</target>

	<target name="compress" description="Deprecated. Only for compatibility">
		<antcall target="pack-jar" />
	</target>
</project>
